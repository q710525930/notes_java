---
typora-copy-images-to: pic
typora-root-url: pic
---

## 分布式系统基础

### 分布式面临的问题

#### 一致性问题

分布式系统中的一致性指**应用系统的一致性和数据的一致性**，多个系统之间互相通信，就有可能遇到例如：

1. **调用超时**：系统A调用系统B超时，系统A得到超时反馈，但不确定系统B是否已经处理结束，就会造成不一致。
2. 掉单：系统A和系统B分别为对方的上下游，如果系统A中存在一个订单，而系统B中不存在，就会导致掉单。
3. **缓存与数据库的不一致**

#### CAP问题

指的是在一个分布式系统中，**Consistency（一致性）**、 **Availability（可用性）**、**Partition tolerance（分区容错性）**，最多实现两点，三者不可兼得。

1. 一致性：在分布式系统中的所有**数据备份**，在同一时刻是否同样的值。
2. 可用性：集群中一部分节点故障后，集群整体是否还能响应客户端的请求。
3. 分区容错性：分布式系统中的节点之间的通信有可能失败，在这种情况下，系统要能够容纳这种错误。

### 一致性协议

一致性协议根据是否允许多个节点进行写操作分为两种：

1. 单主协议：所有**写操作都由主节点处理并且同步给其他副本**。例如主备同步、2PC、Paxos 都属于这类协议。
2. 多主协议：所有**写操作可以由不同节点发起**，并且同步给其他副本。例如 Gossip、POW。

#### 2PC（两阶段提交）

**数据都同步完成之后才返回客户端结果**， 保证所有节点数据一致之后才返回给客户端，实现了顺序一致性。是关系型数据库常用的保持分布式事务一致性的协议，它也属于同步复制协议。保证在分布式事务中，要么所有参与进程都提交事务，要么都取消事务，即**实现 ACID 的原子性（A）**。

主要步骤：

1. 表决阶段：主发送数据给备，所有备都要响应是否可以提交或者回滚，数据放到暂存区
2. 提交阶段：主收集备返回信息，如果有一个备不能提交，则所有回滚。

可以知道过程**十分依赖主备之间的网络通信**，一旦网络出问题就不能写**导致阻塞**，主备同时挂也会导致**数据不一致**，常用于分布式事务。

#### 3PC



#### paxos

属于**分区容忍性**一致协议，也就是说不强制要求所有节点可用，实现了弱一致性。一致性的保证不一定非要所有节点都保持一致，只要大多数节点更新了，对于整个分布式系统来说数据也是一致性的。



